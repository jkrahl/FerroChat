<!DOCTYPE html>
<html>

<head>
  <link rel="manifest" href="manifest.json" />
  <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans" type="text/css" media="screen" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js"></script>
  <script type="module" src="src/main.js"></script>
</head>

<body>
  <div class="chat">
    <div class="chat-title">
      <h1>Asistent Virtual d'FGC</h1>
      <figure class="avatar">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" />
      </figure>
    </div>
    <div class="messages">
      <div class="messages-content">
      </div>
    </div>
    <div class="message-box">
      <textarea type="text" class="message-input" placeholder="Preguntar-me qualsevol cosa!!"></textarea>
      <button type="submit" class="message-submit">Enviar</button>
    </div>

  </div>

  <script type="text/javascript">
    var $messages = $('.messages-content'),
      d, h, m,
      i = 0;

    $(window).load(function () {
      $messages.mCustomScrollbar();
      setTimeout(function () {
        fakeMessage();
      }, 0);
    });

    function updateScrollbar() {
      $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
        scrollInertia: 10,
        timeout: 0
      });
    }

    function setDate() {
      d = new Date()
      if (m != d.getMinutes()) {
        m = d.getMinutes();
        $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
      }
    }

    function insertMessage() {
      msg = $('.message-input').val();
      if ($.trim(msg) == '') {
        return false;
      }
      $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
      setDate();
      $('.message-input').val(null);
      updateScrollbar();
      setTimeout(function () {
        requestMessage(msg);
      }, 0);
    }

    $('.message-submit').click(function () {
      insertMessage();
    });

    $(window).on('keydown', function (e) {
      if (e.which == 13) {
        insertMessage();
        return false;
      }
    })

    var Fake = [
      'Hola, Soc l\'asistent virtual d\'FGC, en que et puc ayudar? ',
      'Para ir de Plaza Cataluña a la UAB en FGC:\nVe a la estación de FGC en Plaza Cataluña.\nToma la línea S2 (Sabadell) o S6 (Universitat Autònoma).\nBaja en la estación "Universitat Autònoma".\nEl trayecto dura aproximadamente 30-35 minutos.',
      'El seiguente S2 pasa en 2 min en via 2',
      'Es todalmente accesible',
      'En esta hora el tren esta vacio',
      'That\'s awesome',
      'Codepen is a nice place to stay',
      'I think you\'re a nice person',
      'Why do you think that?',
      'Can you explain?',
      'Anyway I\'ve gotta go now',
      'It was a pleasure chat with you',
      'Time to make a new codepen',
      'Bye',
      ':)'
    ]




    /* curl https://api.openai.com/v1/threads \
     *   -H "Content-Type: application/json" \
     *   -H "Authorization: Bearer {api_key}"\
     *   -H "OpenAI-Beta: assistants=v2" \
     *   -d ''
     * 
     * curl https://api.openai.com/v1/threads/thread_IViyHhzU6yGJzf5pXu3EcStN/messages \
     *   -H "Content-Type: application/json" \
     *   -H "Authorization: Bearer {api_key}" \
     *   -H "OpenAI-Beta: assistants=v2" \
     *   -d '{
     *       "role": "user",
     *       "content": "s2 pasa por sarria?"
     *     }'
     * 
     * curl https://api.openai.com/v1/threads/{thread_id}/runs \
     *   -H "Authorization: Bearer {api_key}" \
     *   -H "Content-Type: application/json" \
     *   -H "OpenAI-Beta: assistants=v2" \
     *   -d '{
     *     "assistant_id": "{assistant_id}"
     *   }'
     * 
     * curl https://api.openai.com/v1/threads/{thread_id} \
     *   -H "Content-Type: application/json" \
     *   -H "Authorization: Bearer {api_key}" \
     *   -H "OpenAI-Beta: assistants=v2"
     * https://api.openai.com/v1/threads/{thread_id}/messages
     * 
     * curl https://api.openai.com/v1/threads/{thread_id}/messages \
     *   -H "Content-Type: application/json" \
     *   -H "Authorization: Bearer {api_key}" \
     *   -H "OpenAI-Beta: assistants=v2"
     * 
     * 
     * curl https://api.openai.com/v1/threads/thread_IViyHhzU6yGJzf5pXu3EcStN/runs \
     *   -H "Content-Type: application/json" \
     *   -H "OpenAI-Beta: assistants=v2" \
     *   -d '{
     *     "assistant_id": "asst_FJbVXwdh6WiBA6yAQ6LniqOU"
     *   }'
     * 
     * 
     * 
     * curl https://api.openai.com/v1/threads/thread_IViyHhzU6yGJzf5pXu3EcStN/messages \
     *   -H "Content-Type: application/json" \
     *   -H "OpenAI-Beta: assistants=v2" */







    function requestMessage(question) {
      if ($('.message-input').val() != '') {
        return false;
      }





      $('<div class="message loading new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
      updateScrollbar();



      const api_key = prompt("Enter key:");
      const assistant_id = "asst_FJbVXwdh6WiBA6yAQ6LniqOU";

      //    const thread_id = "thread_IViyHhzU6yGJzf5pXu3EcStN";

      //    const thread_id = "thread_VbRuXwOkLzkdlTLQa4CjLiE5";

      // const thread_id = "thread_BbFJM4bw4i87LO5ltYb3pkeo";
      const thread_id = "thread_M0hf36GzRZbNYrcyEJFaKsgE";

      console.log(`${api_key}`);
      fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
        body: {
          "role": "user",
          "content": `${question}`
        },
        headers: {
          'Authorization': `Bearer ${api_key}`,
          "Content-Type": "application/json",
          "Openai-Beta": "assistants=v2"
        },
        method: "POST"
      }).then(
        response => {
          return response.json();
        }
      ).then(
        json => {
          fetch(`https://api.openai.com/v1/threads/${thread_id}/runs`, {
            body: {
              "assistant_id": `${assistant_id}`
            },
            headers: {
              'Authorization': `Bearer ${api_key}`,
              'Content-Type': "application/json",
              'Openai-Beta': "assistants=v2"
            },
            method: "POST"
          }).then(
            response => {
              return response.json();
            }
          ).then(
            json => {
              fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
                headers: {
                  'Authorization': `Bearer ${api_key}`,
                  "Content-Type": "application/json",
                  "Openai-Beta": "assistants=v2"
                }
              }).then(
                response => {
                  return response.json();
                }).then(
                  json => {
                    console.log(json);
                    const chatResponse = json.data[0].content[0].text.value;


                    $('.message.loading').remove();
                    $('<div class="message new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure>' + chatResponse + '</div>').appendTo($('.mCSB_container')).addClass('new');

                    setDate();
                    updateScrollbar();
                    i++;

                  }
                )
            }
          )
        }
      );










      /* const apiUrl = 'https://api.openai.com/v1/threads';
       * 
       * fetch(apiUrl, {
     method: 'POST',
     headers: {
     'Content-Type': 'application/json',
     'Authorization': `Bearer ${apiKey}`,
     },
     body: JSON.stringify({
     "messages": [{
     "role": "assistant",
     "content": "Eres el asistente virtual de los ferrocarriles de la Generalitat de Catalunya."
     }, {
     "role": "user",
     "content": question,
     }]
     })
       * }).then(response => {
     if(!response.ok) {
     throw new Error(`HTTP error! status: ${response.status}`);
     }
     return response.json();
       * }).then(json => {
   console.log(json);
     const chatResponse = json["data"];
     $('.message.loading').remove();
     $('<div class="message new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure>' + chatResponse + '</div>').appendTo($('.mCSB_container')).addClass('new');
 	
     setDate();
     updateScrollbar();
     i++;
       * }).catch(error => {
     console.error('Error:', error);
       * });
       * 
 
       * /* fetch("https://icanhazdadjoke.com/", {
   headers: {
   Accept: "application/json"
   }
       * }).then(
   (response) => {
   return response.json();
   }
       * ).then((json) => {
   $('.message.loading').remove();
   console.log(json)
   $('<div class="message new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure>' + json["joke"] + '</div>').appendTo($('.mCSB_container')).addClass('new');
 
   setDate();
   updateScrollbar();
   i++;
       * }) */

    }

    function fakeMessage() {
      if ($('.message-input').val() != '') {
        return false;
      }

      $('<div class="message loading new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
      updateScrollbar();

      setTimeout(function () {
        $('.message.loading').remove();
        $('<div class="message new"><figure class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/FGC_logo_%282019%29.svg/2048px-FGC_logo_%282019%29.svg.png" /></figure>' + Fake[i] + '</div>').appendTo($('.mCSB_container')).addClass('new');
        setDate();
        updateScrollbar();
        i++;
      }, 500 + (Math.random() * 20) * 100);
    }

  </script>
</body>

</html>